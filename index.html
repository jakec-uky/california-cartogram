<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Cartogram Test</title>
	<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css">

	<style type="text/css">
		body {
      /*background-color: #eeeeee;*/
      color: #333333;
      font-family: sans-serif;
    }
		h1 {
			margin-bottom: 0;
		}
		h2 {
			margin-top: 3px;
		}
		p {
			margin: 5px 1em 1em 5px;
		}
		#descriptive-text {
			float: left;
			width: 25%;
			height: 700px;
			overflow: scroll;
		}
    #map {
      border: 1px solid #dddddd;
      height: 700px;
      margin-bottom: 2rem;
      background-color: #dddddd;
    }
		#ui-slider{
			width: 130px;
		}
		#ui-slider .min {
			float:left;
		}
		#ui-slider .max {
			float:right;
		}
	</style>
</head>

<body>

	<h1>A Century of Growth</h1>
	<h2>population in California, 1900&ndash;2000</h2>
	<div id="descriptive-text">
		<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aenean quis dolor enim. Morbi posuere orci et erat feugiat faucibus quis a nunc. Morbi pharetra odio et tellus ultrices, vitae gravida arcu mattis. Vestibulum vitae purus iaculis, pellentesque nisl vitae, tincidunt diam. Vivamus at velit purus. Mauris pretium sapien risus, blandit sollicitudin orci faucibus a. Nullam convallis hendrerit bibendum. Pellentesque ex erat, vulputate ut placerat in, vehicula at diam. Sed nec ex sed tellus placerat bibendum. Morbi sollicitudin dolor vel feugiat viverra. Praesent cursus justo ac lacus condimentum, viverra mattis erat congue. Maecenas venenatis mi sit amet elit vestibulum scelerisque. Maecenas consectetur nibh et libero pulvinar maximus. Duis sed ultrices ipsum. Suspendisse maximus vitae odio eu fermentum. Integer mattis sit amet nisl ac lobortis.</p>
		<p>Sed blandit gravida commodo. Ut sem orci, semper iaculis dictum et, fermentum in odio. Aliquam at varius elit, non auctor tortor. Vivamus eget diam lacus. Fusce euismod non magna non pulvinar. In nisl turpis, porta a tempus nec, rutrum a orci. Nam libero nisi, dapibus in ex et, venenatis viverra risus. Ut at nunc lectus. In at dolor magna. Sed sollicitudin, enim eget tempor ultrices, tellus odio scelerisque erat, a pretium arcu mi at tortor. Morbi commodo diam eu tempus cursus. Orci varius natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Pellentesque id ex eros. Etiam nec mattis mauris.</p>
		<p>Integer sed augue lacus. Vestibulum eu interdum nulla. Quisque et lacus mauris. Donec aliquam hendrerit tincidunt. Nam et lectus leo. Aliquam odio lacus, tristique eget imperdiet vel, vulputate ut lectus. Integer leo diam, aliquet non arcu ac, euismod aliquam nunc. Sed vitae quam convallis ligula pretium fermentum. Phasellus at sapien fringilla, ultrices elit gravida, tempor leo. Morbi sed ligula nec ligula venenatis scelerisque. Praesent varius velit urna, et vehicula turpis luctus at. Phasellus non est sit amet mi gravida tincidunt. Mauris eu lorem ut ipsum cursus aliquam.</p>
	</div>
	<div id="map"></div>
	<div id="ui-slider">
		<label>
			<span class="min">1900</span>
			<span class="max">2000</span>
			<input type="range" min="1900" max="2000" value="1900" step="100" class="decade-slider"/></input>
		</label>
	</div>
  <p>experimental draft by Jake Coolidge</p>
  <p>data source: US Census</p>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.3.6/papaparse.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.5/chroma.min.js"></script>

	<script>
		var options = {
			scrollWheelZoom: true,
			zoomSnap: .5,
			dragging: true,
			zoomControl: true
		}

		var map = L.map('map', options);//.setView([41.505, -116.09], 5);


		// AJAX request for GeoJSON data
		$.getJSON("data/ca_cartogram_2000.json", function (counties) {
			$.getJSON("data/adjacent_states.json", function (states) {
				drawCartogram(counties);
	      console.log(counties);
			});
		});

    function drawCartogram(counties) {
      var dataLayer = L.geoJson(counties, {
        style: function(feature) {
          return {
            color: '#ffffff',
            weight: 1,
            fillOpacity: 1,
            fillColor: feature.properties["hex"]//'#000000'
          }
        },
        onEachFeature: function(feature, layer) {
          layer.on('mouseover', function(){
            layer.setStyle({
              color: '#f0f40f',
              weight: 2
            }).bringToFront();
          });
          layer.on('mouseout', function() {
            layer.setStyle({
              color: '#ffffff',
              weight: 1
            });
          });
          var tooltipInfo = layer.feature.properties["name"] + " County<br />pop: " + layer.feature.properties["population"];
          layer.bindTooltip(tooltipInfo, {
            sticky: true,
            tooltipAnchor: [200, 200]
          })
        }
      }).addTo(map);

      map.fitBounds(dataLayer.getBounds(), {
        paddingTopLeft: [0,0]
      });
    }

		function updateMap(dataLayer, colorize, currentYear) {
			//obviously, this was written to assign new colors to existing geometries
			//based on user input. in contrast, i'm interested in REMOVING one json layer
			//and adding a different one based on user input
			// loop through data once
			map.removeLayer(dataLayer)
			dataLayer.eachLayer(function (layer) {

				//set the tooltip content based on what's being passed to the function
				var tooltipInfo = "<b>" + layer.feature.properties["NAME"] + "</b><br>" +
					layer.feature.properties[currentYear] + "% unemployment in " + [currentYear];
				//apply above to the tooltip
				layer.setTooltipContent(tooltipInfo);
				//create a variable from the properties
				var props = layer.feature.properties;
				//use the variable above in this set style. also colorize based on what's being passed to the function
				layer.setStyle({
					fillColor: colorize(Number(props[currentYear]))
				})
			})
		} //end updateMap

		function createSliderUI(dataLayer, colorize) {
			var sliderControl = L.control({
				position: 'bottomleft'
			});

			sliderControl.onAdd = function (map) {
				var slider = L.DomUtil.get("ui-slider");
				L.DomEvent.disableScrollPropagation(slider);
				L.DomEvent.disableClickPropagation(slider);
				return slider;
			}

			sliderControl.addTo(map);

			$(".decade-slider").on("input change", function () {
				var currentYear = this.value;
				console.log("slider happened");
				updateMap(dataLayer, colorize, currentYear)
				//updateLegend(currentYear)
			});
		} //end createSliderUI

// end cartogram script
/*
		function drawRemovedGeoms(geoms) {
			var dataLayer = L.geoJson(geoms, {
				style: function (feature) {
					return {
						color: 'black',
						weight: 1,
						fillOpacity: 1,
						fillColor: '#dddddd'
					};
				},
				onEachFeature: function (feature, layer) {
					// when mousing over a layer
					layer.on('mouseover', function () {
						// change the stroke color and bring that element to the front
						layer.setStyle({
							color: '#ffffff' //'#ff6e00'
						}).bringToFront();
					});
					// on mousing off layer
					layer.on('mouseout', function () {
						// reset the layer style to its original stroke color
						layer.setStyle({
							color: 'black'
						});
					});
					layer.bindTooltip("No data available", {
						sticky: true,
						tooltipAnchor: [200, 200]
					});
				}
			}).addTo(map);
		};

		function processData(counties, data) {
			//loop through all counties
			for (var i = 0; i < counties.features.length; i++) {
				//create a variable for county properties because it's kind of long to write out
				var props = counties.features[i].properties;
				//for each of the csv data rows
				for (var j = 0; j < data.data.length; j++) {
					//conditional statement to see if county fips code and data fips code match; remember they have different names
					if (props.GEOID === data.data[j].STATE_FIP + data.data[j].COUNTY_FIP) {
						//console.log('county geoid: ', props.GEOID);
						//console.log('data fip: ', (data.data[j].STATE_FIP + data.data[j].COUNTY_FIP));
						counties.features[i].properties = data.data[j];
						//console.log(counties.features[i]);
						break; //this speeds up processing by kicking back out to the outer loop when a match is found in the inner loop
					}
				}
			} // end of outer loop

			console.log('after: ', counties);
			// looks good!

			// now that the counties have had year-by-year stats appended to them, we can come up with a data classification scheme

			// create an empty array to store all data values across all years
			var rates = [];

			//iterate through all counties
			counties.features.forEach(function (county) {
				//iterate through all the props of each county
				for (var prop in county.properties) {
					//if the attribute is a number and not one of the fips codes or a name
					//prop != "NAME" (rates.push(Number(county.properties[prop]));)
					if (prop != "COUNTY_FIP" && prop != "STATE_FIP" && prop != "NAME") {
						rates.push(Number(county.properties[prop]));
					}
				}
			});

			// verify the result!
			console.log(rates);

			var breaks = chroma.limits(rates, 'q', 5);
			//console.log(breaks);

			var colorize = chroma.scale(chroma.brewer.OrRd).classes(breaks).mode('lab');
			console.log(colorize(7));
			drawMap(counties, colorize);
			drawLegend(breaks, colorize);
		};

		function drawMap(counties, colorize) {
			var dataLayer = L.geoJson(counties, {
				style: function (feature) {
					return {
						color: 'black',
						weight: 1,
						fillOpacity: 1,
						fillColor: '#1f78b4'
					};
				},
				onEachFeature: function (feature, layer) {
					// when mousing over a layer
					layer.on('mouseover', function () {
						// change the stroke color and bring that element to the front
						layer.setStyle({
							color: '#ffffff' //'#ff6e00'
						}).bringToFront();
					});
					// on mousing off layer
					layer.on('mouseout', function () {
						// reset the layer style to its original stroke color
						layer.setStyle({
							color: 'black'
						});
					});
					// begin by binding an empty tooltip
					layer.bindTooltip('', {
							sticky: true,
							tooltipAnchor: [200, 200]
						});
						}
					}).addTo(map);

			// fit bounds to bounding box of continental us
			map.fitBounds([[51.2, -65.43], [21.9, -125.5]])

			updateMap(dataLayer, colorize, '2001');
			createSliderUI(dataLayer, colorize);
		}

		function updateMap(dataLayer, colorize, currentYear) {
			// loop through data once
			dataLayer.eachLayer(function (layer) {


				var tooltipInfo = "<b>" + layer.feature.properties["NAME"] + "</b><br>" +
					layer.feature.properties[currentYear] + "% unemployment in " + [currentYear];

				layer.setTooltipContent(tooltipInfo);

				var props = layer.feature.properties;

				layer.setStyle({
					fillColor: colorize(Number(props[currentYear]))
				})
			})
		} //end updateMap

		function createSliderUI(dataLayer, colorize) {
			var sliderControl = L.control({
				position: 'bottomleft'
			});

			sliderControl.onAdd = function (map) {
				var slider = L.DomUtil.get("ui-controls");
				L.DomEvent.disableScrollPropagation(slider);
				L.DomEvent.disableClickPropagation(slider);
				return slider;
			}

			sliderControl.addTo(map);

			$(".year-slider").on("input change", function () {
				var currentYear = this.value;
				updateMap(dataLayer, colorize, currentYear)
				updateLegend(currentYear)
			});
		} //end createSliderUI

		function drawLegend(breaks, colorize) {
			var legendControl = L.control({
				position: 'topright'
			});

			legendControl.onAdd = function (map) {
				//create a div with the id legend; it will be empty at this point
				var legend = L.DomUtil.create('div', 'legend');
				return legend;
			};

			legendControl.addTo(map);

			//use jQuery ($) to select the div with id legend created above
			var legend = $('.legend').html("<h3><span>2001</span> Unemployment Rates</h3><ul>");
			console.log(breaks);

			for (var i = 0; i < breaks.length - 1; i++) {
				var color = colorize(breaks[i], breaks);
				var classRange = '<li><span style="background:' + color + '"></span><label>' +
					breaks[i].toLocaleString() + ' &mdash; ' +
					breaks[i + 1].toLocaleString() + '%</label></li>'

				$('.legend ul').append(classRange);
			}

			legend.append("</ul>");
		}

		function updateLegend(currentYear) {
			var legendYear = $('.legend h3 span').html(currentYear)
		}*/
	</script>

</body>

</html>
