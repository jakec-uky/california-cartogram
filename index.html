<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Cartogram Test</title>
	<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css">

	<style type="text/css">
		body {
      background-color: #333333;
      color: #eeeeee;
    }
	</style>
</head>

<body>

	<h1>Cartogram Test</h1>
	<div id="map"></div>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.3.6/papaparse.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.5/chroma.min.js"></script>

	<script>
		var options = {
			scrollWheelZoom: true,
			zoomSnap: .5,
			dragging: true,
			zoomControl: false
		}

		var map = L.map('map', options).setView([41.505, -96.09], 5);

/*
		// AJAX request for GeoJSON data
		$.getJSON("data/us-counties.json", function (counties) {

			// AJAX request for GeoJSON data
			$.getJSON("data/removed-geometries.json", function (geoms) {

				// AJAX request for CSV data
				Papa.parse('data/us-unemployment-counties.csv', {
					download: true,
					header: true,
					complete: function (data) {
						drawRemovedGeoms(geoms)
						processData(counties, data);
					}
				});
			})
		});

		function drawRemovedGeoms(geoms) {
			var dataLayer = L.geoJson(geoms, {
				style: function (feature) {
					return {
						color: 'black',
						weight: 1,
						fillOpacity: 1,
						fillColor: '#dddddd'
					};
				},
				onEachFeature: function (feature, layer) {
					// when mousing over a layer
					layer.on('mouseover', function () {
						// change the stroke color and bring that element to the front
						layer.setStyle({
							color: '#ffffff' //'#ff6e00'
						}).bringToFront();
					});
					// on mousing off layer
					layer.on('mouseout', function () {
						// reset the layer style to its original stroke color
						layer.setStyle({
							color: 'black'
						});
					});
					layer.bindTooltip("No data available", {
						sticky: true,
						tooltipAnchor: [200, 200]
					});
				}
			}).addTo(map);
		};

		function processData(counties, data) {
			//loop through all counties
			for (var i = 0; i < counties.features.length; i++) {
				//create a variable for county properties because it's kind of long to write out
				var props = counties.features[i].properties;
				//for each of the csv data rows
				for (var j = 0; j < data.data.length; j++) {
					//conditional statement to see if county fips code and data fips code match; remember they have different names
					if (props.GEOID === data.data[j].STATE_FIP + data.data[j].COUNTY_FIP) {
						//console.log('county geoid: ', props.GEOID);
						//console.log('data fip: ', (data.data[j].STATE_FIP + data.data[j].COUNTY_FIP));
						counties.features[i].properties = data.data[j];
						//console.log(counties.features[i]);
						break; //this speeds up processing by kicking back out to the outer loop when a match is found in the inner loop
					}
				}
			} // end of outer loop

			console.log('after: ', counties);
			// looks good!

			// now that the counties have had year-by-year stats appended to them, we can come up with a data classification scheme

			// create an empty array to store all data values across all years
			var rates = [];

			//iterate through all counties
			counties.features.forEach(function (county) {
				//iterate through all the props of each county
				for (var prop in county.properties) {
					//if the attribute is a number and not one of the fips codes or a name
					//prop != "NAME" (rates.push(Number(county.properties[prop]));)
					if (prop != "COUNTY_FIP" && prop != "STATE_FIP" && prop != "NAME") {
						rates.push(Number(county.properties[prop]));
					}
				}
			});

			// verify the result!
			console.log(rates);

			var breaks = chroma.limits(rates, 'q', 5);
			//console.log(breaks);

			var colorize = chroma.scale(chroma.brewer.OrRd).classes(breaks).mode('lab');
			console.log(colorize(7));
			drawMap(counties, colorize);
			drawLegend(breaks, colorize);
		};

		function drawMap(counties, colorize) {
			var dataLayer = L.geoJson(counties, {
				style: function (feature) {
					return {
						color: 'black',
						weight: 1,
						fillOpacity: 1,
						fillColor: '#1f78b4'
					};
				},
				onEachFeature: function (feature, layer) {
					// when mousing over a layer
					layer.on('mouseover', function () {
						// change the stroke color and bring that element to the front
						layer.setStyle({
							color: '#ffffff' //'#ff6e00'
						}).bringToFront();
					});
					// on mousing off layer
					layer.on('mouseout', function () {
						// reset the layer style to its original stroke color
						layer.setStyle({
							color: 'black'
						});
					});
					// begin by binding an empty tooltip
					layer.bindTooltip('', {
							sticky: true,
							tooltipAnchor: [200, 200]
						});
						}
					}).addTo(map);

			// fit bounds to bounding box of continental us
			map.fitBounds([[51.2, -65.43], [21.9, -125.5]])

			updateMap(dataLayer, colorize, '2001');
			createSliderUI(dataLayer, colorize);
		}

		function updateMap(dataLayer, colorize, currentYear) {
			// loop through data once
			dataLayer.eachLayer(function (layer) {


				var tooltipInfo = "<b>" + layer.feature.properties["NAME"] + "</b><br>" +
					layer.feature.properties[currentYear] + "% unemployment in " + [currentYear];

				layer.setTooltipContent(tooltipInfo);

				var props = layer.feature.properties;

				layer.setStyle({
					fillColor: colorize(Number(props[currentYear]))
				})
			})
		}

		function createSliderUI(dataLayer, colorize) {
			var sliderControl = L.control({
				position: 'bottomleft'
			});

			sliderControl.onAdd = function (map) {
				var slider = L.DomUtil.get("ui-controls");
				L.DomEvent.disableScrollPropagation(slider);
				L.DomEvent.disableClickPropagation(slider);
				return slider;
			}

			sliderControl.addTo(map);

			$(".year-slider").on("input change", function () {
				var currentYear = this.value;
				updateMap(dataLayer, colorize, currentYear)
				updateLegend(currentYear)
			});
		}

		function drawLegend(breaks, colorize) {
			var legendControl = L.control({
				position: 'topright'
			});

			legendControl.onAdd = function (map) {
				//create a div with the id legend; it will be empty at this point
				var legend = L.DomUtil.create('div', 'legend');
				return legend;
			};

			legendControl.addTo(map);

			//use jQuery ($) to select the div with id legend created above
			var legend = $('.legend').html("<h3><span>2001</span> Unemployment Rates</h3><ul>");
			console.log(breaks);

			for (var i = 0; i < breaks.length - 1; i++) {
				var color = colorize(breaks[i], breaks);
				var classRange = '<li><span style="background:' + color + '"></span><label>' +
					breaks[i].toLocaleString() + ' &mdash; ' +
					breaks[i + 1].toLocaleString() + '%</label></li>'

				$('.legend ul').append(classRange);
			}

			legend.append("</ul>");
		}

		function updateLegend(currentYear) {
			var legendYear = $('.legend h3 span').html(currentYear)
		}*/
	</script>

</body>

</html>
